# Protobuf è¿›é˜¶è¯­æ³•

* ğŸ‘‹ Hi, Iâ€™m liubo
* ğŸ‘€ Iâ€™m interested in harmony
* ğŸŒ± Iâ€™m currently learning harmony
* ğŸ’ï¸ Iâ€™m looking to collaborate on ...
* ğŸ“« How to reach me ...



## ä¿ç•™å­—æ®µ

å½“ä¸å†éœ€è¦æŸä¸ªå­—æ®µæ—¶ï¼Œä¸å»ºè®®ä»æ¶ˆæ¯ä¸­åˆ é™¤æˆ–æ³¨é‡Šå­—æ®µå®šä¹‰ï¼Œreservedä¿ç•™å­—æ®µç¼–å·ï¼Œä»¥ç¡®ä¿è¯¥ç¼–å·å°†ä¸èƒ½è¢«é‡å¤ä½¿ç”¨ã€‚

ä¾‹å¦‚æœ‰ä¸¤ä¸ªæœåŠ¡ï¼Œä»–ä»¬å„è‡ªä½¿ç”¨â¼€ä»½.protoæ–‡ä»¶ï¼Œå†…å®¹çº¦å®šå¥½äº†æ˜¯â¼€æ¨¡â¼€æ ·çš„ã€‚å¦‚æœä¸ä¿ç•™å­—æ®µç¼–å·ï¼Œå¯¹.protoæ–‡ä»¶è¿›è¡Œæ›´æ–°æ—¶å¯èƒ½ä¼šé‡ç”¨å·²åˆ é™¤å­—æ®µç¼–å·ï¼Œå½“ä¸¤ä¸ªæœåŠ¡æ²¡æœ‰åŒæ­¥æ›´æ–°æ—¶å¯èƒ½å¯¹è¯¥å­—æ®µç¼–å·çš„å®šä¹‰ä¸ä¸€è‡´ä½†å¹¶ä¸ä¼šæŠ¥é”™ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„é—®é¢˜ï¼ŒåŒ…æ‹¬æ•°æ®æŸåã€éšç§æ¼æ´ç­‰ã€‚å¦‚æœè¯¥å­—æ®µç¼–å·ç”¨reservedæ ‡æ³¨ï¼Œè¿™æ ·ï¼Œå½“è¿™ä¸ªå­—æ®µç¼–å·æˆ–è€…å­—æ®µåå­—è¢«é‡æ–°ä½¿ç”¨çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ä»¥é¿å…ä¸Šè¿°é—®é¢˜ã€‚



```protobuf
message Message 
{
	// è®¾ç½®ä¿ç•™é¡¹
	reserved 100, 101, 200 to 299;
	reserved "field3", "field4";
	// æ³¨æ„ï¼šä¸è¦åœ¨â¼€â¾ reserved å£°æ˜ä¸­åŒæ—¶å£°æ˜å­—æ®µç¼–å·å’Œåç§°ã€‚
	// reserved 102, "field5";
	// è®¾ç½®ä¿ç•™é¡¹ä¹‹åï¼Œä¸‹â¾¯ä»£ç ä¼šå‘Šè­¦
	int32 field1 = 100; //å‘Šè­¦ï¼šField 'field1' uses reserved number 100
	int32 field2 = 101; //å‘Šè­¦ï¼šField 'field2' uses reserved number 101
	int32 field3 = 102; //å‘Šè­¦ï¼šField name 'field3' is reserved
	int32 field4 = 103; //å‘Šè­¦ï¼šField name 'field4' is reserved
}

```



## å¤æ‚å­—æ®µç±»å‹

### æšä¸¾

æšä¸¾ç±»å‹åä½¿ç”¨é©¼å³°æ‹¼å†™æ³•(CamelCase )ï¼Œå€¼åä½¿ç”¨å¤§å†™å­—æ¯åŠ ä¸‹åˆ’çº¿(CAPITALS_WITH_UNDERSCORES)

protobufä¸­æšä¸¾ç±»å‹æ„å»ºè§„åˆ™å¦‚ä¸‹ï¼š

- å¿…é¡»æœ‰ä¸€ä¸ªé›¶å€¼ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä½¿ç”¨0ä½œä¸ºæ•°å­—é»˜è®¤å€¼ã€‚
- é›¶å€¼å¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»¥ä¾¿ä¸proto2è¯­ä¹‰å…¼å®¹ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæšä¸¾å€¼å§‹ç»ˆæ˜¯é»˜è®¤å€¼ã€‚
- ä¸è¦ä½¿ç”¨è´Ÿæ•°ä½œä¸ºæšä¸¾å€¼ï¼Œç¼–ç æ•ˆç‡ä½ã€‚
- æ¯ä¸ªæšä¸¾å€¼åº”ä»¥åˆ†å·ç»“æŸï¼Œè€Œä¸æ˜¯é€—å·ã€‚



```protobuf
enum Foo {
  FIRST_VALUE = 0;
  SECOND_VALUE = 1;
}

message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
  enum Corpus {
    UNIVERSAL = 0;
    WEB = 1;
    IMAGES = 2;
    LOCAL = 3;
    NEWS = 4;
    PRODUCTS = 5;
    VIDEO = 6;
  }
  Corpus corpus = 4;
}
```



å¯ä»¥é€šè¿‡ä¸ºä¸åŒçš„æšä¸¾å¸¸é‡åˆ†é…ç›¸åŒçš„å€¼æ¥å®šä¹‰åˆ«åã€‚ä¸ºæ­¤ï¼Œéœ€è¦å°†allow_aliasé€‰é¡¹è®¾ç½®ä¸ºtrueï¼Œå¦åˆ™åè®®ç¼–è¯‘å™¨ä¼šåœ¨æ‰¾åˆ°åˆ«åæ—¶ç”Ÿæˆé”™è¯¯æ¶ˆæ¯ã€‚

```protobuf
enum EnumAllowingAlias {
  option allow_alias = true;
  UNKNOWN = 0;
  STARTED = 1;
  RUNNING = 1;
}
enum EnumNotAllowingAlias {
  UNKNOWN = 0;
  STARTED = 1;
  // RUNNING = 1;  // Uncommenting this line will cause a compile error inside Google and a warning message outside.
}
```

å¦‚æœä½ åœ¨ç‰ˆæœ¬å¼€å‘çš„è¿‡ç¨‹ä¸­ç§»é™¤äº†æŸä¸ªæšä¸¾ï¼Œä½†æ˜¯åœ¨è€çš„åè®®ä¸­è¿˜ä¼šä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨reservedå…³é”®å­—æ ‡è¯†ã€‚ è¯·æ³¨æ„ï¼Œä¸èƒ½åœ¨åŒä¸€ä¿ç•™è¯­å¥ä¸­æ··åˆå­—æ®µåå’Œæ•°å€¼ã€‚

```protobuf
enum Foo {
  reserved 2, 15, 9 to 11, 40 to max;
  reserved "FOO", "BAR";
}
```



### æ¶ˆæ¯ç±»å‹

å¯ä»¥ä½¿ç”¨å…¶ä»–æ¶ˆæ¯ç±»å‹ä½œä¸ºå­—æ®µç±»å‹

```protobuf
message Result {
  string url = 1;
  string title = 2;
  repeated string snippets = 3;
}
message SearchResponse {
  repeated Result results = 1;
}
```

## æ¶ˆæ¯åµŒå¥—

å¯ä»¥åœ¨å…¶ä»–æ¶ˆæ¯ç±»å‹ä¸­å®šä¹‰å’Œä½¿ç”¨æ¶ˆæ¯ç±»å‹ï¼Œå¦‚ä¸‹ä¾‹ï¼š

```protobuf
message SearchResponse {
  message Result {
    string url = 1;
    string title = 2;
    repeated string snippets = 3;
  }
  repeated Result results = 1;
}
```

å¦‚æœæƒ³åœ¨å…¶çˆ¶æ¶ˆæ¯ç±»å‹ä¹‹å¤–é‡ç”¨æ­¤æ¶ˆæ¯ç±»å‹ï¼Œåˆ™éœ€è¦å…ˆæŒ‡å®šå®ƒçš„çˆ¶ç±»å‹ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```protobuf
message SomeOtherMessage {
  SearchResponse.Result result = 1;
}
```

å¯ä»¥å¤šé‡åµŒå¥—

```protobuf
message Outer {                  // Level 0
  message MiddleAA {  // Level 1
    message Inner {   // Level 2
      int64 ival = 1;
      bool  booly = 2;
    }
  }
  message MiddleBB {  // Level 1
    message Inner {   // Level 2
      int32 ival = 1;
      bool  booly = 2;
    }
  }
}
```





## æ·»åŠ æ³¨é‡Š

proto æ·»åŠ æ³¨é‡Š,ä½¿ç”¨ C/C++é£æ ¼çš„ // æˆ–è€… /* â€¦ */ è¯­æ³•.





## æœåŠ¡

å¦‚æœè¦åœ¨RPCï¼ˆRemote Procedure Callï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰ç³»ç»Ÿä¸­ä½¿ç”¨æ¶ˆæ¯ç±»å‹ï¼Œå¯ä»¥åœ¨.protoæ–‡ä»¶ä¸­å®šä¹‰RPCæœåŠ¡æ¥å£ï¼Œåè®®ç¼“å†²åŒºç¼–è¯‘å™¨å°†æ ¹æ®æ‰€é€‰è¯­è¨€ç”ŸæˆæœåŠ¡æ¥å£ä»£ç å’Œå­˜æ ¹ã€‚

```protobuf
service FooService {
  rpc GetSomething(FooRequest) returns (FooResponse);
}
```



æ›´æ–°æ¶ˆæ¯ç±»å‹

å¦‚æœç°æœ‰çš„æ¶ˆæ¯ç±»å‹ä¸æ»¡è¶³ä½ çš„æ‰€æœ‰éœ€æ±‚â€”â€”ä¾‹å¦‚ï¼Œä½ å¸Œæœ›æ¶ˆæ¯æ ¼å¼æœ‰ä¸€ä¸ªé¢å¤–çš„å­—æ®µâ€”â€”ä½†æ˜¯ä½ ä»ç„¶å¸Œæœ›ä½¿ç”¨ç”¨æ—§æ ¼å¼åˆ›å»ºçš„ä»£ç ï¼Œåˆ«æ‹…å¿ƒï¼åœ¨ä¸ç ´åä»»ä½•ç°æœ‰ä»£ç çš„æƒ…å†µä¸‹æ›´æ–°æ¶ˆæ¯ç±»å‹éå¸¸ç®€å•ã€‚è¯·è®°ä½ä»¥ä¸‹è§„åˆ™:

- ä¸è¦æ›´æ”¹ä»»ä½•ç°æœ‰å­—æ®µçš„å­—æ®µç¼–å·ã€‚
- å¦‚æœæ‚¨æ·»åŠ æ–°å­—æ®µï¼Œåˆ™ä½¿ç”¨â€œæ—§â€æ¶ˆæ¯æ ¼å¼çš„ä»£ç åºåˆ—åŒ–çš„ä»»ä½•æ¶ˆæ¯ä»ç„¶å¯ä»¥ç”±æ–°ç”Ÿæˆçš„ä»£ç è§£æã€‚æ‚¨åº”è¯¥è®°ä½è¿™äº›å…ƒç´ çš„é»˜è®¤å€¼ï¼Œä»¥ä¾¿æ–°ä»£ç å¯ä»¥æ­£ç¡®åœ°ä¸æ—§ä»£ç ç”Ÿæˆçš„æ¶ˆæ¯äº¤äº’ã€‚ç±»ä¼¼åœ°ï¼Œæ–°ä»£ç åˆ›å»ºçš„æ¶ˆæ¯å¯ä»¥ç”±æ—§ä»£ç è§£æï¼šæ—§äºŒè¿›åˆ¶æ–‡ä»¶åœ¨è§£ææ—¶ä¼šå¿½ç•¥æ–°å­—æ®µã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æœªçŸ¥å­—æ®µéƒ¨åˆ†ã€‚
- åªè¦åœ¨æ›´æ–°çš„æ¶ˆæ¯ç±»å‹ä¸­ä¸å†ä½¿ç”¨å­—æ®µç¼–å·ï¼Œå°±å¯ä»¥åˆ é™¤å­—æ®µã€‚æ‚¨å¯èƒ½æƒ³è¦é‡å‘½åè¯¥å­—æ®µï¼Œå¯èƒ½æ·»åŠ å‰ç¼€â€œOBSOLETE_â€ï¼Œæˆ–å°†å­—æ®µç¼–å·è®¾ä¸ºä¿ç•™ï¼Œä»¥ä¾¿æ‚¨çš„æœªæ¥ç”¨æˆ·.protoä¸ä¼šæ„å¤–é‡ç”¨è¯¥ç¼–å·ã€‚
- int32ã€uint32ã€int64ã€uint64å’Œbooléƒ½æ˜¯å…¼å®¹çš„â€”â€”è¿™æ„å‘³ç€æ‚¨å¯ä»¥å°†å­—æ®µä»å…¶ä¸­ä¸€ç§ç±»å‹æ›´æ”¹ä¸ºå¦ä¸€ç§ç±»å‹ï¼Œè€Œä¸ä¼šç ´åå‘å‰æˆ–å‘åå…¼å®¹æ€§ã€‚å¦‚æœä»ä¸é€‚åˆç›¸åº”ç±»å‹çš„çº¿è·¯ä¸­è§£æå‡ºä¸€ä¸ªæ•°å­—ï¼Œæ‚¨å°†è·å¾—ä¸åœ¨ C++ ä¸­å°†è¯¥æ•°å­—å¼ºåˆ¶è½¬æ¢ä¸ºè¯¥ç±»å‹ç›¸åŒçš„æ•ˆæœï¼ˆä¾‹å¦‚ï¼Œå¦‚æœå°† 64 ä½æ•°å­—è¯»å–ä¸ºint32ï¼Œå®ƒå°†è¢«æˆªæ–­ä¸º 32 ä½ï¼‰ã€‚
- sint32å¹¶ä¸”sint64å½¼æ­¤å…¼å®¹ï¼Œä½†ä¸å…¶ä»–æ•´æ•°ç±»å‹ä¸å…¼å®¹ã€‚
- åªè¦å­—èŠ‚æ˜¯æœ‰æ•ˆçš„UTF - 8ï¼Œstringå’Œbyteså°±å…¼å®¹
- fixed32ä¸sfixed32å…¼å®¹ï¼Œ fixed64ä¸sfixed64å…¼å®¹ã€‚
- â€¦



## Oneof

å¦‚æœæ‚¨æœ‰ä¸€æ¡åŒ…å«å¤šä¸ªå­—æ®µçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”æœ€å¤šåŒæ—¶è®¾ç½®ä¸€ä¸ªå­—æ®µï¼Œå¯ä»¥å¼ºåˆ¶æ‰§è¡Œæ­¤è¡Œä¸ºå¹¶ä½¿ç”¨ oneof åŠŸèƒ½èŠ‚çœå†…å­˜ã€‚

ä¸€ä¸ªoneofå…±äº«å†…å­˜ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œæœ€å¤šå¯ä»¥åŒæ—¶è®¾ç½®ä¸€ä¸ªå­—æ®µï¼Œå…¶ä»–ä¸å¸¸è§„å­—æ®µä¸€æ ·ã€‚è®¾ç½®oneofçš„ä»»ä½•æˆå‘˜ä¼šè‡ªåŠ¨æ¸…é™¤æ‰€æœ‰å…¶ä»–æˆå‘˜ã€‚å¯ä»¥ä½¿ç”¨case()æˆ–WhichOneof()æ–¹æ³•æ£€æŸ¥Oneofä¸­çš„å“ªä¸ªå€¼è¢«è®¾ç½®(å¦‚æœæœ‰çš„è¯)ï¼Œå…·ä½“å–å†³äºé€‰æ‹©çš„è¯­è¨€ã€‚


oneofå…³é”®å­—åè·Ÿoneofåç§°ï¼Œç„¶åå¤§æ‹¬å·é‡Œé¢åŒ…å«å¤šä¸ªå­—æ®µã€‚

```protobuf
message SampleMessage {
  oneof test_oneof {
    string name = 4;
    SubMessage sub_message = 9;
  }
}
```

æ³¨æ„ï¼š

- oneofå­—æ®µä¸èƒ½è¢«repeatedå’Œmapä¿®é¥°
- è®¾ç½®oneofå­—æ®µå°†è‡ªåŠ¨æ¸…é™¤oneofçš„æ‰€æœ‰å…¶ä»–æˆå‘˜ã€‚å› æ­¤ï¼Œå¦‚æœè®¾ç½®äº†oneofä¸­çš„å¤šä¸ªå­—æ®µï¼Œåˆ™åªæœ‰æœ€åè®¾ç½®çš„å­—æ®µä»ç„¶æœ‰å€¼ã€‚

```c++
SampleMessage message;
message.set_name("name");
CHECK(message.has_name());
message.mutable_sub_message(); // Will clear name field.
CHECK(!message.has_name());
```

- å¦‚æœä½¿ç”¨çš„æ˜¯C++ï¼Œç¡®ä¿ä»£ç ä¸ä¼šå¯¼è‡´å†…å­˜å´©æºƒã€‚ä»¥ä¸‹ç¤ºä¾‹ä»£ç å°†ä¼šå´©æºƒï¼Œå› ä¸ºé€šè¿‡è°ƒç”¨set_name()æ–¹æ³•å·²ç»åˆ é™¤äº†sub_messageã€‚

```c++
SampleMessage message;
SubMessage* sub_message = message.mutable_sub_message();
message.set_name("name");      // å°†åˆ é™¤ sub_message
sub_message->set_...            // è¿™é‡Œå´©æºƒäº†
```

è¿˜æ˜¯åœ¨C++ä¸­ï¼Œå¦‚æœä½ ç”¨Swap()ä¸¤ä¸ªå¸¦æœ‰oneofçš„æ¶ˆæ¯ï¼Œåˆ™æ¯æ¡æ¶ˆæ¯éƒ½å°†æ‹¥æœ‰å¯¹æ–¹çš„å€¼ï¼šåœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œmsg1å°†æ‹¥æœ‰sub_messageï¼Œè€Œmsg2å°†æ‹¥æœ‰nameã€‚

```C++
SampleMessage msg1;
msg1.set_name("name");
SampleMessage msg2;
msg2.mutable_sub_message();
msg1.swap(&msg2);
CHECK(msg1.has_sub_message());
CHECK(msg2.has_name());
```



## Maps



è¯­æ³•ï¼š

```protobuf
map<key_type, value_type> map_field = N;
```

- å…¶ä¸­key_typeå¯ä»¥æ˜¯ä»»ä½•æ•´æ•°æˆ–å­—ç¬¦ä¸²ç±»å‹ï¼ˆå› æ­¤ï¼Œé™¤æµ®ç‚¹ç±»å‹å’Œä¹‹å¤–çš„ä»»ä½•æ ‡é‡ç±»å‹ï¼‰ã€‚è¯·æ³¨æ„ï¼Œ enum ä¸æ˜¯æœ‰æ•ˆçš„key_type.
- value_typeå¯ä»¥æ˜¯é™¤äº†mapä»¥å¤–çš„ä»»ä½•ç±»å‹



















---
---
---
---
---
---
---
---
---
---
---







